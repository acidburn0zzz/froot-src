Main Server Code
================

src/ directory:
---------------

main.cc
-------

Handles command line arguments, creates a `Server` object and then
starts multiple threads for handling queries.

server.cc
---------

The main coordination class, which receives payload frames from the
network stack, creating a `Context` for each DNS query and subequently
passes the entire response back to the network stack.

context.cc
----------

The `Context` class contains the state associated with an incoming
query, the functions for parsing that query into that state, look-up
of the corresponding answer for the query, and subsequent collation
of the entire response into the `iovec[]` which will be passed back
to the network layer.

answer.cc
---------

Encapsulates a pre-computed `Answer`, and also sets of answers where
the latter contains an answer for each specific class of response
that can be generated by the server.

The `Answer` class only contains the Answer, Authority and Additional
sections of a response, with compression pointers pre-calculated
assuming the minimal possible QNAME in the Question section.

If the QNAME is longer than this then the `data_offset_by()` method
returns a copy of the answer with the compression pointers adjusted
to compensate for the additional size of the Question section.

include/buffer.h
----------------

A pair of classes (`ReadBuffer` and `WriteBuffer`) which encapsulate
operations for sequentially reading or storing data into a memory
buffer.

The classes use C++ templates to handle automatic serialization of
compound objects in buffers.   For example,

```
auto& tx_hdr = head.reserve<dnshdr>();
```

reserves the amount of space required for a `dnshdr` object (adjusting
the offset for the next operation accordingly) and aliases that memory
space into the reference variable `tx_hdr` such that subsequent writes
to that variable's members will get written to the buffer.

rrlist.cc, rrlist.h
-------------------

The `RRList` contains both a list of resource records and the RRSIGs
associated with them.

timer.cc, timer.h
-----------------

Operators for manipulating `timespec` objects.

util.cc, util.h
---------------

Miscellaneous utility functions that don't clearly fit into any
individual class.

zone.cc, zone.h
---------------

The `Zone` class handles loading a zone file in RFC 1035 master file
format, and then pre-compiling an `AnswerSet` for each TLD therein.

Network Stack
=============

NB: All code in the src/netserver/ directory

netserver.cc, netserver.h
-------------------------

Defines an abstraction layer for handling packets and passing them up
and down the network stack.   Also defines a generic NetserverPacket
container which retains the state of a packet as it moves around between
layers.

checksum.h
----------

Used to calculate rolling checksums of IP data, per RFC 791.

afpacket.cc, afpacket.h
-----------------------

Serves as an input and output layer for the network stack, receiving
raw frames from the Linux kernel in `AF_PACKET` mode and passing them
to the appropriate layer-three protocol handler.  Network reads use
a memory-mapped `PACKET_RX_RING` to increase performance.

arp.cc, arp.h
-------------

ARP layer for responding to ARP requests for the configured IPv4
address of the stack.

ipv4.cc, ipv4.h
---------------

IPv4 layer.  Handles outbound fragmentation, but not inbound.

ipv6.cc, ipv6.h
---------------

IPv6 layer.  Handles outbound fragmentation, but not inbound.  Will
attempt to skip and ignore any additional Extension Headers seen on
inbound packets.

It automatically creates a link-local EUI64 format address from the
MAC address of the network interface, and will forward on packets
addressed to that address, any additional configured address, and
also to any associated Solicited Node address.

icmp.cc, icmp.h
---------------

ICMP layer for IPv4.  It only responds to `ICMP_ECHO_REQUEST packets`.

icmpv6.cc, icmpv6.h
-------------------

ICMP layer for IPv6.  It responses to Neighbor Discovery packets and
ICMPv6 Echo Request packets.

udp.cc, udp.h
-------------

UDP layer - handles dispatch on a per-port basis to higher layers and
calculates checksums as necessary on responses (e.g. for IPv6)

tcp.cc, tcp.h
-------------

An implementation of Stateless TCP (per Huston et al) that can handle
short-lived TCP connections by simply sending all payload packets at
once and ignoring any ACK packets sent by the client.  Retries are
therefore not supported.

Test and Benchmarking Code
==========================

Source in tests/

lightbench.cc
------------

Loads a 10M record file of queries and tests the throughput of a
`Context` in parsing and generating answers to those queries.  NB:
this does not execute the raw IP packet handling code, just memory
buffers containing queries and responses.

benchmark.cc, benchmark.h
-------------------------

A `BenchmarkTimer` class that uses scoped RAII to measure the runtime
of a block of code.

queryfile.cc, queryfile.h
-------------------------

Loads queries from a binary data file, either in a raw binary
format or the text-based format used by `dnsperf`.
